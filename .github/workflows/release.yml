name: Release

on:
  push:
    tags: ["v*"]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Install deps
        run: sudo apt install gcc-arm-none-eabi binutils-arm-none-eabi libcapstone-dev ant openjdk-8-jdk python3

      - name: Install agbcc
        run: |
          git clone https://github.com/pret/agbcc.git
          cd agbcc
          ./build.sh
          ./install.sh ../

      - name: Build FireRed
        run: |
          make -j${nproc}
          make -j${nproc} dev

      - name: Build Randomizer
        run: |
          git clone https://github.com/PikalaxALT/universal-pokemon-randomizer UPR -b fr-support
          python3 .github/workflows/update_config.py UPR/src/com/dabomstew/pkrandom/config/gen3_offsets.ini pokefirered-speedchoice.ini
          cd UPR
          wget https://versaweb.dl.sourceforge.net/project/launch4j/launch4j-3/3.14/launch4j-3.14-linux-x64.tgz
          tar -xzvf launch4j-3.14-linux-x64.tgz
          ant -f .github/ant/build.xml

      - name: Package Release
        run: |
          read addr size type name <<< $(nm -SBgn pokefirered-speedchoice.elf | grep -w gSpeedchoiceVersion)
          verstr=$(dd if=pokefirered-speedchoice.gba bs=1 skip=$((0x${addr} & 0xFFFFFF)) count=$((0x${size} - 1)))
          export relname=pokemon-firered-speedchoice-${verstr}-plus-randomizer
          mkdir ${relname}
          cp -r pokefirered-speedchoice.gba UPR/build/$(date '+%Y%m%d')/* ${relname}/
          zip -r ${relname}.zip ${relname}/

      - name: Publish
        uses: marvinpinto/action-automatic-releases@latest
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: false
          files: pokemon-firered-speedchoice-*-plus-randomizer.zip
